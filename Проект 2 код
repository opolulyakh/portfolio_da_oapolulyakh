with 
-- 1 
first_payments as 
(select user_id
        ,min(date_trunc('day',transaction_datetime)) as first_payment_date
from skyeng_db.payments
where status_name = 'success'
group by user_id
order by user_id,first_payment_date)
,
-- 2 
all_date as
(select distinct date_trunc('day',class_start_datetime) as dt
from SKYENG_DB.classes
where date_part('year',class_start_datetime) = 2016)
,
-- 3 
all_dates_by_user as
(select user_id
        ,dt
from  first_payments
    left join all_date 
    on first_payment_date <= dt
)
,
-- 4 
payments_by_dates as 
(
select user_id
        ,date_trunc('day',transaction_datetime) as payment_date
        ,sum(classes) as transaction_balance_change 
from skyeng_db.payments
where status_name = 'success'
group by user_id, payment_date
order by user_id, payment_date
),
-- 5 

payments_by_dates_cumsum as
(
select adu.user_id
        ,dt
        ,coalesce(transaction_balance_change,0) as transaction_balance_change
        , sum(transaction_balance_change) over (partition by adu.user_id order by dt) as transaction_balance_change_cs
from all_dates_by_user adu 
        left join payments_by_dates pd 
    on adu.user_id = pd.user_id
        and dt = payment_date
order by adu.user_id,dt
)

-- select *
-- from payments_by_dates_cumsum

-- 6  
, classes_by_dates as
(select user_id
        ,date_trunc('day',class_start_datetime) as class_date
        , count (id_class)*-1 as classes
from SKYENG_DB.classes
where class_status in ('success','failed_by_student')
        and class_type != 'trial'
group by user_id, date_trunc('day',class_start_datetime)
)

-- 7
, classes_by_dates_dates_cumsum as 
(
select adu.user_id
      ,dt
      ,coalesce(classes,0) as classes
      ,sum(classes) over (partition by adu.user_id order by dt) classes_cs
from  all_dates_by_user adu
    left join classes_by_dates cbd
        on adu.user_id = cbd.user_id
        and class_date = dt 
order by adu.user_id, dt
)
,

-- 8 
balance as
(select a.user_id
        , a.dt
        , transaction_balance_change
        , transaction_balance_change_cs
        , classes
        , coalesce(classes_cs,0) as classes_cs
        , classes_cs + transaction_balance_change_cs as balance
from payments_by_dates_cumsum a 
    join classes_by_dates_dates_cumsum b 
  using (user_id,dt)
order by a.user_id,a.dt
)

select sum(transaction_balance_change) as transaction_balance_change_sum
        , sum (transaction_balance_change_cs) as transaction_balance_change_cs_sum
        , sum (classes) as classes_sum 
        , sum(classes_cs) as classes_cs_sum
        , sum(balance) as balance_sum 
        ,dt
from balance
group by dt
order by dt
